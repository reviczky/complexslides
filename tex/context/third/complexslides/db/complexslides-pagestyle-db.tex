\startmodule complexslides-stylestyle-db

\unprotect

\setupheader[\c!style=\bf\ssc, \c!before=\vss, \c!after=\vss, \c!color=base:0]
\setupfooter[\c!style=small]
\setuptext  [\c!style=bold, \c!color=base:0]

\setupheadertexts[{\getmarking[section]}]

\ifdim\layoutparameter\c!rightmargin > 2pt
    \setuptexttexts[margin][][\setups{complexslides:toc}]
\fi

\ifdim\layoutparameter\c!leftmargin > 2pt
    \setuptexttexts[margin][\setups{complexslides:toc}][]
\fi

\defineframed
  [complexslides:toc]
  [
    \c!frame=\v!on,
    \c!frame=\v!on,
  ]

\startsetups complexslides:toc
  \getvalue{complexslides:toc}
      { Topics }
\stopsetups

\setuphead[subject,section]
          [\c!style=\bf\ssc,
           \c!color=foreground:1,
       \c!placehead=\v!empty,
          \c!number=\v!no,
            \c!page=\v!yes, % topspace?
          \c!before=,
%           \c!after={\blank[\v!small]},
           \c!after=,
          ]

\definehead
  [slide]
  [section]
  [
    \c!coupling=\v!section,
    \c!default=\v!section,
  ]

\definemakeup
  [slide]
  [
     \c!doublesided=\v!no,
     \c!page=\v!yes,
     \c!top=\vss,
     \c!bottom=\vss,
     \c!bottomstate=\v!normal,
     \c!topstate=\v!normal,
     \c!textstate=\v!normal,
     \c!headerstate=\v!stop,
     \c!footerstate=\v!stop,
     \c!pagestate=\v!stop,
     \c!style={\switchtobodyfont[24pt]\setupinterlinespace},
     \c!color=foreground:2,
     \c!align=\v!middle,
   ]

\definemakeup
  [titlepage]
  [slide]
  [\c!style=]

\startreusableMPgraphic {complexslides:pagebackground}
  StartPage;
  % fill Page withcolor \MPcolor{foreground:1};
  % circular_shade (Page, 4, \MPcolor{foreground:1}, \MPcolor{base:1});
  newpath page_boundary;
  if "\currentmakeup" = "" :
      page_boundary :=  complexslides_lccorner Field[LeftMarginSeparator][Bottom]
                     -- center Field[LeftMarginSeparator][HeaderSeparator]
                     -- center Field[RightMarginSeparator][HeaderSeparator]
                     -- complexslides_lccorner Field[RightMarginSeparator][Bottom]
                     -- cycle ;
  else :
      page_boundary := Field[Text][Text];
  fi;

  fill page_boundary superellipsed 0.98 withcolor \MPcolor{background:0};
  StopPage;
\stopreusableMPgraphic

\startuniqueMPgraphic{complexslides:pagebackground:logo}{color}
  drawoptions (withcolor \MPvar{color});
  input db-logo;
\stopuniqueMPgraphic

\startuniqueMPgraphic{complexslides:pagebackground:identifier}{color}
  drawoptions (withcolor \MPvar{color});
  input db-identifier;
\stopuniqueMPgraphic

\defineoverlay[complexslides:pagebackground][\useMPgraphic{complexslides:pagebackground}]

% FIXME - image as var and location !!!
\definelayer[complexslides:pagebackground:image:bridge1][x=0mm,y=0mm,width=\paperwidth,height=\paperheight,preset=righttop,state=start]
\setlayer[complexslides:pagebackground:image:bridge1][hoffset=0mm,voffset=0mm]{\externalfigure[awm][width=\paperwidth]}

% .5 size logo: 7mm,7mm
\definelayer[complexslides:pagebackground:logo:invers][x=0mm,y=0mm,width=\paperwidth,height=\paperheight,preset=righttop,state=start]
\setlayer[complexslides:pagebackground:logo:invers][hoffset=14mm,voffset=14mm]{\framed[frame=off,offset=0mm,strut=no,width=14mm,height=14mm]{\scale[width=14mm,height=14mm]{\useMPgraphic{complexslides:pagebackground:logo}{color=background:0}}}}

\definelayer[complexslides:pagebackground:identifier][x=0mm,y=0mm,width=\paperwidth,height=\paperheight,preset=lefttop,state=start]
\setlayer[complexslides:pagebackground:identifier][hoffset=7mm,voffset=14mm]{\scale[height=10mm]{\useMPgraphic{complexslides:pagebackground:identifier}{color=background:0}}}

\definelayer[complexslides:pagebackground:logo][x=0mm,y=0mm,width=\paperwidth,height=\paperheight,preset=righttop,state=continue]
\setlayer[complexslides:pagebackground:logo][hoffset=14mm,voffset=14mm]{\framed[frame=off,offset=0mm,strut=no,width=14mm,height=14mm]{\scale[width=14mm,height=14mm]{\useMPgraphic{complexslides:pagebackground:logo}{color=foreground:1}}}}

%\setupbackgrounds[\v!page][\c!background={complexslides:pagebackground}]
\setupbackgrounds[\v!page][\c!background={complexslides:pagebackground:image:bridge1,complexslides:pagebackground:identifier,complexslides:pagebackground:logo:invers,complexslides:pagebackground:logo}]

\protect

\stopmodule
